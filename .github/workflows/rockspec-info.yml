name: Get Rockspec Info
on:
  workflow_call:
    outputs:
      info:
        description: "JSON object with rockspec info"
        value: ${{ jobs.rockspec-info.outputs.info }}

jobs:
  rockspec-info:
    runs-on: ubuntu-latest
    outputs:
      info: ${{ steps.pkg-info.outputs.info }}
    steps:
      - uses: actions/checkout@v4
      - name: Fetch release please manifest
        id: manifest
        run: |
            version=$(jq --raw-output '."."' < .release-please-manifest.json)
            echo "version=$version" >> $GITHUB_OUTPUT
      - name: Construct rockspec package names
        id: pkg-info
        run: |
          echo 'info<<EOF' >> $GITHUB_OUTPUT
          echo '"{' >> $GITHUB_OUTPUT
          echo '\"server\":{\"version\":\"${{ steps.manifest.outputs.version }}\",\"rockspec\":\"launchdarkly-server-sdk-${{ steps.manifest.outputs.version }}-0.rockspec\"},' >> $GITHUB_OUTPUT
          echo '\"redis\":{\"version\":\"${{ steps.manifest.outputs.version }}\",\"rockspec\":\"launchdarkly-server-sdk-redis-${{ steps.manifest.outputs.version }}-0.rockspec\"}' >> $GITHUB_OUTPUT
          echo '}"' >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
